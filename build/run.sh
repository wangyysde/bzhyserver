#!/usr/bin/env bash

###############################
# @Copyright Bzhy Network
# @HomePage http://www.sysadm.cn
# @Version 0.21.03
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# @License GNU Lesser General Public License  https://www.sysadm.cn/lgpl.html
# @Modified Apr 10 2021
##############################


SYSADM_ROOT=$(dirname "${BASH_SOURCE[0]}")/..
VERSION=$(/usr/bin/cat /data/code/golang/src/bzhyProjects/bzhyserver/VERSION)
PROGNAME="sysadm"
PREFIX="/usr/local/${PROGNAME}"
CONFFILE="${PREFIX/conf/${PROGNAME}.conf}"

#For default server settings
LISTEN="0.0.0.0"
PORT="8080"
ROOTPATH="html"
PIDPATH="/var/run/sysadm.pid"
INDEXS="index.html index.htm"

#For logger
LOGLEVEL="debug"
ACCESSLOG="logs/sysadm-access.log"
ERRORLOG="logs/sysadm-error.log"
LOGTYPE="text"

PHONY="all server install clean"

#define License message
datestr=$(/usr/bin/date "+%Y%m%d %H:%M:%S")

function help::show::usage() {
  /usr/bin/echo "Usage: ${0} -p <PrefixPath> -a <Action> -c <ConfigFile>"
  /usr/bin/echo
  /usr/bin/echo "Options:"
  /usr/bin/echo "  -h      Show this usage mesage"
  /usr/bin/echo "  -p      Specify the destination path that the application will install to"
  /usr/bin/echo "  -a      Which action will be exectue.It must be one of the below list."
  /usr/bin/echo "  -c      Specify the path of configuration file of the application"
  /usr/bin/echo 
  /usr/bin/echo "Actions:"
  /usr/bin/echo "  server         Building server component"
  /usr/bin/echo "  all            Building the all components"
  /usr/bin/echo "  clean          Clean last built files"
  /usr/bin/echo "  install        Install the built files into the destination path"
  exit 0 
}

function generate_default_config(){
  if [ ${CONFFILE:0:1} != "/" ]
  then
    CONFFILE="${PREFIX}/${CONFFILE}"
  fi
  
  /usr/bin/echo "Generating ${SYSADM_ROOT}/pkg/config/defaultSettings.go ..."
  /usr/bin/cat >"${SYSADM_ROOT}/pkg/config/defaultSettings.go" <<EOF
/*
* @Copyright Bzhy Network
* @HomePage http://www.sysadm.cn
* @Version 0.21.03
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
* http://www.apache.org/licenses/LICENSE-2.0
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
* @License GNU Lesser General Public License  https://www.sysadm.cn/lgpl.html
**/

//NOTE: This file be generated by building scripts. DON'T EDIT THIS FILE.
//Generated at: ${datestr}

package config

/* DefaultConfigs for default configs of application */
var DefaultAppSettings = appSetting{
    Progname:   "${PROGNAME}",
    Proversion: "${VERSION}",
    Prefix:     "${PREFIX}",
    ConFile:    "${CONFFILE}",
}

//Define default value for server settings
var defaultServerSettings = server{
    Listen:   "${LISTEN}",
    Port:     ${PORT},
    RootPath: "${ROOTPATH}",
    PidPath:  "${PIDPATH}",
    Indexs:   "${INDEXS}",
}

var defaultLoggerSettings = logger{
    Loglevel:  "${LOGLEVEL}",
    AccessLog: "${ACCESSLOG}",
    ErrorLog:  "${ERRORLOG}",
    Logtype:   "$LOGTYPE",
}

EOF
}

function do_action(){
  generate_default_config
  cd ${SYSADM_ROOT}
  case "$1" in
    server)
      /usr/bin/make server
      ;;
    clean)
      /usr/bin/echo "Cleaning built files..."
      rm -rf  ${SYSADM_ROOT}/bin/*
      rm -rf ${PREFIX}
      ;;
    install)
      chmod +x ${SYSADM_ROOT}/build/install.sh
      ${SYSADM_ROOT}/build/install.sh      
      ;;
    all)
      /usr/bin/make server
      chmod +x ${SYSADM_ROOT}/build/install.sh
      ${SYSADM_ROOT}/build/install.sh
      ;;
  esac
}


while getopts :hp:a:c: opts
do
  case "$opts" in
    h)
      help::show::usage
      ;;
    p)
      PREFIX=$OPTARG
      ;;
    a)
      ACTION=$OPTARG
      ;;
    c)
      CONFFILE=$OPTARG
      ;;
    ?)
      help::show::usage
      ;;
  esac
done
 
if [ $# -eq 0 ]
then  
  help::show::usage
fi

if [ ! -z ${ACTION} ]
then
  do_action ${ACTION}
fi
